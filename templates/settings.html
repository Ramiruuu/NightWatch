<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NightWatch - Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../static/css/settings.css">
</head>
<body>
    <div class="nav-bar">
        <a href="/"><i class="bi bi-speedometer2"></i> Dashboard</a>
        <a href="/logs"><i class="bi bi-journal-text"></i> Logs</a>
        <a href="/settings" class="active"><i class="bi bi-gear"></i> Settings</a>
        <span style="float: right; color: var(--terminal-green);">
            <i class="bi bi-wifi"></i> <span id="connectionStatus">Connected</span>
        </span>
    </div>

    <div class="settings-container">
        <!-- Server Configuration -->
        <div class="settings-card">
            <div class="card-header">
                <i class="bi bi-hdd-network me-2"></i>Server Configuration
            </div>
            
            <div class="setting-row">
                <span class="setting-label">TCP Port</span>
                <input type="number" class="setting-input" id="tcpPort" value="4444" min="1" max="65535">
            </div>
            
            <div class="setting-row">
                <span class="setting-label">UDP Port</span>
                <input type="number" class="setting-input" id="udpPort" value="4445" min="1" max="65535">
            </div>
            
            <div class="setting-row">
                <span class="setting-label">Bind Address</span>
                <input type="text" class="setting-input" id="bindAddress" value="0.0.0.0" placeholder="0.0.0.0">
            </div>
            
            <div class="info-box">
                <i class="bi bi-info-circle me-2"></i>
                <strong>0.0.0.0</strong> listens on all interfaces. Use <strong>127.0.0.1</strong> for local only.
            </div>
            
            <button class="btn-save" onclick="saveServerConfig()">
                <i class="bi bi-check-circle me-2"></i>Save Server Configuration
            </button>
        </div>

        <!-- Logging Settings -->
        <div class="settings-card">
            <div class="card-header">
                <i class="bi bi-journal-text me-2"></i>Logging Settings
            </div>
            
            <div class="checkbox-row">
                <input type="checkbox" id="logToFile" checked>
                <label for="logToFile">Save logs to file</label>
            </div>
            
            <div class="checkbox-row">
                <input type="checkbox" id="logTimestamps" checked>
                <label for="logTimestamps">Include timestamps</label>
            </div>
            
            <div class="checkbox-row">
                <input type="checkbox" id="logIPs" checked>
                <label for="logIPs">Log IP addresses</label>
            </div>
            
            <div class="checkbox-row">
                <input type="checkbox" id="logMessages" checked>
                <label for="logMessages">Log message contents</label>
            </div>
            
            <div class="setting-row">
                <span class="setting-label">Max log size</span>
                <select class="setting-input" id="maxLogSize">
                    <option value="100">100 messages</option>
                    <option value="500">500 messages</option>
                    <option value="1000" selected>1000 messages</option>
                    <option value="5000">5000 messages</option>
                    <option value="10000">10000 messages</option>
                </select>
            </div>
            
            <button class="btn-save" onclick="saveLogConfig()">
                <i class="bi bi-check-circle me-2"></i>Save Logging Settings
            </button>
        </div>

        <!-- Security Settings -->
        <div class="settings-card">
            <div class="card-header">
                <i class="bi bi-shield-lock me-2"></i>Security Settings
            </div>
            
            <div class="checkbox-row">
                <input type="checkbox" id="requireAuth">
                <label for="requireAuth">Require authentication for web UI</label>
            </div>
            
            <div class="setting-row">
                <span class="setting-label">Username</span>
                <input type="text" class="setting-input" id="username" value="admin" disabled>
            </div>
            
            <div class="setting-row">
                <span class="setting-label">Password</span>
                <input type="password" class="setting-input" id="password" value="nightwatch" disabled>
            </div>
            
            <div class="checkbox-row">
                <input type="checkbox" id="enableTLS">
                <label for="enableTLS">Enable HTTPS/TLS</label>
            </div>
            
            <div class="checkbox-row">
                <input type="checkbox" id="ipWhitelist">
                <label for="ipWhitelist">Enable IP whitelist</label>
            </div>
            
            <div class="setting-row">
                <span class="setting-label">Allowed IPs</span>
                <input type="text" class="setting-input" id="allowedIPs" value="127.0.0.1,192.168.1." placeholder="Comma-separated IPs/ranges">
            </div>
            
            <button class="btn-save" onclick="saveSecurityConfig()">
                <i class="bi bi-check-circle me-2"></i>Save Security Settings
            </button>
        </div>

        <!-- Appearance -->
        <div class="settings-card">
            <div class="card-header">
                <i class="bi bi-palette me-2"></i>Appearance
            </div>
            
            <div class="setting-row">
                <span class="setting-label">Theme</span>
                <select class="setting-input" id="theme" onchange="changeTheme(this.value)">
                    <option value="dark" selected>Dark (default)</option>
                    <option value="light">Light</option>
                    <option value="matrix">Matrix (green)</option>
                    <option value="amber">Amber</option>
                </select>
            </div>
            
            <div class="setting-row">
                <span class="setting-label">Font size</span>
                <select class="setting-input" id="fontSize">
                    <option value="12">Small (12px)</option>
                    <option value="14" selected>Medium (14px)</option>
                    <option value="16">Large (16px)</option>
                    <option value="18">Extra Large (18px)</option>
                </select>
            </div>
            
            <div class="checkbox-row">
                <input type="checkbox" id="compactView">
                <label for="compactView">Compact view (show more logs)</label>
            </div>
            
            <div class="checkbox-row">
                <input type="checkbox" id="autoScroll" checked>
                <label for="autoScroll">Auto-scroll to new logs</label>
            </div>
            
            <button class="btn-save" onclick="saveAppearanceConfig()">
                <i class="bi bi-check-circle me-2"></i>Save Appearance Settings
            </button>
        </div>

        <!-- Keyboard Shortcuts -->
        <div class="settings-card">
            <div class="card-header">
                <i class="bi bi-keyboard me-2"></i>Keyboard Shortcuts
            </div>
            
            <div class="key-bind">
                <span>Start TCP Server</span>
                <span>Ctrl+1</span>
            </div>
            <div class="key-bind">
                <span>Stop TCP Server</span>
                <span>Ctrl+2</span>
            </div>
            <div class="key-bind">
                <span>Start UDP Server</span>
                <span>Ctrl+3</span>
            </div>
            <div class="key-bind">
                <span>Stop UDP Server</span>
                <span>Ctrl+4</span>
            </div>
            <div class="key-bind">
                <span>Clear Logs</span>
                <span>Ctrl+L</span>
            </div>
            <div class="key-bind">
                <span>Export Logs</span>
                <span>Ctrl+E</span>
            </div>
            <div class="key-bind">
                <span>Dashboard</span>
                <span>Alt+1</span>
            </div>
            <div class="key-bind">
                <span>Logs Page</span>
                <span>Alt+2</span>
            </div>
            <div class="key-bind">
                <span>Settings</span>
                <span>Alt+3</span>
            </div>
            
            <div class="info-box warning" style="margin-top: 15px;">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Keyboard shortcuts work when dashboard has focus
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="settings-card">
            <div class="card-header" style="color: var(--terminal-red);">
                <i class="bi bi-exclamation-triangle me-2"></i>Danger Zone
            </div>
            
            <div class="info-box error">
                <strong>Warning:</strong> These actions cannot be undone!
            </div>
            
            <button class="btn-danger" style="width: 100%; margin-bottom: 10px;" onclick="clearAllLogs()">
                <i class="bi bi-eraser me-2"></i>Clear All Logs
            </button>
            
            <button class="btn-danger" style="width: 100%; margin-bottom: 10px;" onclick="resetToDefaults()">
                <i class="bi bi-arrow-counterclockwise me-2"></i>Reset to Default Settings
            </button>
            
            <button class="btn-danger" style="width: 100%;" onclick="restartServer()">
                <i class="bi bi-arrow-repeat me-2"></i>Restart Server
            </button>
        </div>

        <!-- System Info -->
        <div class="settings-card">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>System Information
            </div>
            
            <div class="key-bind">
                <span>Version</span>
                <span>NightWatch v1.0.0</span>
            </div>
            <div class="key-bind">
                <span>Python Version</span>
                <span id="pythonVersion">3.8+</span>
            </div>
            <div class="key-bind">
                <span>Flask Version</span>
                <span id="flaskVersion">2.x</span>
            </div>
            <div class="key-bind">
                <span>Server Uptime</span>
                <span id="uptime">Calculating...</span>
            </div>
            <div class="key-bind">
                <span>Total Connections</span>
                <span id="totalConns">0</span>
            </div>
            <div class="key-bind">
                <span>Active Listeners</span>
                <span id="activeListeners">None</span>
            </div>
            
            <button class="btn-save" style="margin-top: 15px;" onclick="refreshSystemInfo()">
                <i class="bi bi-arrow-repeat me-2"></i>Refresh Info
            </button>
        </div>
    </div>

    <script>
        // Load settings when page loads
        window.onload = function() {
            loadSettings();
            refreshSystemInfo();
        };

        function loadSettings() {
            // Load from localStorage or set defaults
            const tcpPort = localStorage.getItem('tcpPort') || '4444';
            const udpPort = localStorage.getItem('udpPort') || '4445';
            const bindAddress = localStorage.getItem('bindAddress') || '0.0.0.0';
            
            document.getElementById('tcpPort').value = tcpPort;
            document.getElementById('udpPort').value = udpPort;
            document.getElementById('bindAddress').value = bindAddress;
            
            // Load theme
            const theme = localStorage.getItem('theme') || 'dark';
            document.getElementById('theme').value = theme;
            changeTheme(theme);
        }

        function saveServerConfig() {
            const config = {
                tcpPort: document.getElementById('tcpPort').value,
                udpPort: document.getElementById('udpPort').value,
                bindAddress: document.getElementById('bindAddress').value
            };
            
            localStorage.setItem('tcpPort', config.tcpPort);
            localStorage.setItem('udpPort', config.udpPort);
            localStorage.setItem('bindAddress', config.bindAddress);
            
            alert('Server configuration saved! Restart server to apply changes.');
        }

        function saveLogConfig() {
            const config = {
                logToFile: document.getElementById('logToFile').checked,
                logTimestamps: document.getElementById('logTimestamps').checked,
                logIPs: document.getElementById('logIPs').checked,
                logMessages: document.getElementById('logMessages').checked,
                maxLogSize: document.getElementById('maxLogSize').value
            };
            
            localStorage.setItem('logConfig', JSON.stringify(config));
            alert('Logging settings saved!');
        }

        function saveSecurityConfig() {
            alert('Security settings saved! (Authentication not yet implemented)');
        }

        function saveAppearanceConfig() {
            const config = {
                theme: document.getElementById('theme').value,
                fontSize: document.getElementById('fontSize').value,
                compactView: document.getElementById('compactView').checked,
                autoScroll: document.getElementById('autoScroll').checked
            };
            
            localStorage.setItem('theme', config.theme);
            localStorage.setItem('fontSize', config.fontSize);
            localStorage.setItem('compactView', config.compactView);
            localStorage.setItem('autoScroll', config.autoScroll);
            
            // Apply font size
            document.body.style.fontSize = config.fontSize + 'px';
            
            alert('Appearance settings saved!');
        }

        function changeTheme(theme) {
            const root = document.documentElement;
            
            if (theme === 'dark') {
                root.style.setProperty('--dark-bg', '#1a1a1a');
                root.style.setProperty('--darker-bg', '#0d0d0d');
                root.style.setProperty('--terminal-green', '#00ff00');
            } else if (theme === 'light') {
                root.style.setProperty('--dark-bg', '#f5f5f5');
                root.style.setProperty('--darker-bg', '#ffffff');
                root.style.setProperty('--terminal-green', '#006600');
                document.body.style.color = '#333';
            } else if (theme === 'matrix') {
                root.style.setProperty('--terminal-green', '#00ff00');
                root.style.setProperty('--dark-bg', '#000000');
                root.style.setProperty('--darker-bg', '#0a0a0a');
            } else if (theme === 'amber') {
                root.style.setProperty('--terminal-green', '#ffb86c');
                root.style.setProperty('--dark-bg', '#2d2a1e');
                root.style.setProperty('--darker-bg', '#1e1b15');
            }
        }

        function clearAllLogs() {
            if (confirm('⚠️ Are you sure? This will delete ALL logs permanently!')) {
                fetch('/api/clear', { method: 'POST' })
                    .then(() => alert('All logs cleared!'))
                    .catch(err => alert('Error clearing logs: ' + err));
            }
        }

        function resetToDefaults() {
            if (confirm('⚠️ Reset all settings to default values?')) {
                localStorage.clear();
                location.reload();
            }
        }

        function restartServer() {
            if (confirm('⚠️ Restart server? This will disconnect all clients.')) {
                fetch('/api/stop/all', { method: 'POST' })
                    .then(() => {
                        alert('Server stopped. Please restart manually from command line.');
                    });
            }
        }

        function refreshSystemInfo() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalConns').textContent = data.total_connections || 0;
                    
                    let listeners = [];
                    if (data.tcp_running) listeners.push('TCP:4444');
                    if (data.udp_running) listeners.push('UDP:4445');
                    document.getElementById('activeListeners').textContent = listeners.length ? listeners.join(', ') : 'None';
                    
                    document.getElementById('uptime').textContent = 'Running';
                })
                .catch(() => {
                    document.getElementById('uptime').textContent = 'Unknown';
                });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === '1') {
                e.preventDefault();
                fetch('/api/start/tcp', {method: 'POST'});
            } else if (e.ctrlKey && e.key === '2') {
                e.preventDefault();
                fetch('/api/stop/tcp', {method: 'POST'});
            } else if (e.ctrlKey && e.key === '3') {
                e.preventDefault();
                fetch('/api/start/udp', {method: 'POST'});
            } else if (e.ctrlKey && e.key === '4') {
                e.preventDefault();
                fetch('/api/stop/udp', {method: 'POST'});
            } else if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                clearAllLogs();
            }
        });
    </script>
</body>
</html>